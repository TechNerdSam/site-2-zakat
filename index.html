<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application de Zakat Professionnelle - Précis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root { --teal-500: #14b8a6; --teal-600: #0d9488; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.08);
        }
        
        .tab-button.active { border-bottom-color: var(--teal-500); color: var(--teal-500); font-weight: 700; }

        .tooltip-container { position: relative; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
        .tooltip-text {
            visibility: hidden; width: 250px; background-color: #1f2937; color: #fff; text-align: center;
            border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 50; bottom: 130%;
            left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 13px; line-height: 1.6;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        .result-card { transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(20px); opacity: 0; }
        .result-card.show { transform: translateY(0); opacity: 1; }
        
        .loader { border: 2px solid #e5e7eb; border-top: 2px solid #ef4444; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }

        @media print {
            body * { visibility: hidden; }
            #results, #results * { visibility: visible; }
            #results { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="glass-card shadow-2xl rounded-3xl p-6 md:p-10">
            <!-- En-tête -->
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight">Zakat Pro</h1>
                    <p class="text-gray-600 mt-1 text-lg">Votre calculateur de Zakat fiable et précis.</p>
                </div>
                <div class="flex items-center space-x-4 no-print">
                    <button id="guideBtn" class="p-2 rounded-full hover:bg-gray-200 transition">
                        <i class="fa-solid fa-book-open text-gray-600"></i>
                    </button>
                </div>
            </div>

            <!-- Onglets -->
            <div class="border-b border-gray-200 mb-6 no-print">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button class="tab-button active py-3 px-1 border-b-2 font-medium text-sm" data-tab="calculator">
                        <i class="fa-solid fa-calculator mr-2"></i>Calculateur
                    </button>
                    <button class="tab-button py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 border-transparent" data-tab="history">
                         <i class="fa-solid fa-history mr-2"></i>Historique
                    </button>
                    <button class="tab-button py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 border-transparent" data-tab="charities">
                         <i class="fa-solid fa-hands-holding-child mr-2"></i>Organismes
                    </button>
                     <button class="tab-button py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 border-transparent" data-tab="settings">
                        <i class="fa-solid fa-cog mr-2"></i>Paramètres
                    </button>
                </nav>
            </div>
            
            <!-- Contenu des onglets -->
            <div id="tab-content">
                <div id="calculator-tab" class="space-y-8">
                    <div id="calculator-form">
                        <!-- Section 1: Paramètres du Nisab -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                               <label for="currency" class="block text-sm font-bold text-gray-700 mb-2">Devise</label>
                               <select id="currency" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 transition"></select>
                           </div>
                           <div>
                               <label class="block text-sm font-bold text-gray-700 mb-2">Base du Nisab</label>
                               <div class="flex bg-gray-50 border border-gray-300 rounded-lg p-1">
                                   <button id="nisab_gold_btn" class="w-1/2 p-2 rounded-md text-sm font-semibold">Or (85g)</button>
                                   <button id="nisab_silver_btn" class="w-1/2 p-2 rounded-md text-sm font-semibold">Argent (595g)</button>
                               </div>
                           </div>
                           <!-- NOUVEAU: Champs pour le prix des métaux -->
                            <div class="relative">
                               <label for="gold_price_gram" class="block text-sm font-bold text-gray-700 mb-2">Prix de l'Or par gramme</label>
                               <input type="number" id="gold_price_gram" placeholder="Ex: 68.50" class="w-full p-3 pr-10 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                               <span id="currency-symbol-gold" class="absolute right-3 top-10 text-gray-500">€</span>
                           </div>
                           <div class="relative">
                               <label for="silver_price_gram" class="block text-sm font-bold text-gray-700 mb-2">Prix de l'Argent par gramme</label>
                               <input type="number" id="silver_price_gram" placeholder="Ex: 0.85" class="w-full p-3 pr-10 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                               <span id="currency-symbol-silver" class="absolute right-3 top-10 text-gray-500">€</span>
                           </div>
                        </div>

                        <!-- Section 2: Actifs -->
                        <div class="mt-8">
                           <h3 class="text-xl font-bold text-gray-800 border-b border-gray-300 pb-2 mb-4">Actifs Zakatables</h3>
                           <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div class="flex items-center gap-2"><input type="number" id="cash" placeholder="Liquidités" class="asset-input w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" min="0"><div class="tooltip-container"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltip-text">Argent en banque, en espèces, sur des comptes courants ou d'épargne.</span></div></div>
                                <div class="flex items-center gap-2"><input type="number" id="other_savings" placeholder="Actions & Placements" class="asset-input w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" min="0"><div class="tooltip-container"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltip-text">Valeur marchande actuelle de vos actions, obligations et autres placements destinés à la croissance.</span></div></div>
                                <div class="flex items-center gap-2"><input type="number" id="gold_grams" placeholder="Or (en grammes)" class="asset-input w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" min="0"><div class="tooltip-container"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltip-text">Poids en grammes de tout l'or que vous possédez (bijoux, lingots), sauf les bijoux personnels de femme selon certains avis.</span></div></div>
                                <div class="flex items-center gap-2"><input type="number" id="silver_grams" placeholder="Argent (en grammes)" class="asset-input w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" min="0"><div class="tooltip-container"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltip-text">Poids total en grammes de l'argent que vous possédez.</span></div></div>
                                <div class="flex items-center gap-2"><input type="number" id="crypto" placeholder="Cryptomonnaies" class="asset-input w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" min="0"><div class="tooltip-container"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltip-text">Valeur actuelle de vos cryptomonnaies si détenues comme investissement.</span></div></div>
                                <div class="flex items-center gap-2"><input type="number" id="business_assets" placeholder="Actifs commerciaux" class="asset-input w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" min="0"><div class="tooltip-container"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltip-text">Valeur de l'inventaire/stock et des créances clients. N'incluez pas les actifs fixes (bâtiments, véhicules).</span></div></div>
                                <div class="flex items-center gap-2"><input type="number" id="real_estate" placeholder="Immobilier (revente)" class="asset-input w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" min="0"><div class="tooltip-container"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltip-text">Valeur des biens immobiliers achetés avec l'intention de les revendre. N'incluez pas votre résidence principale.</span></div></div>
                                <div class="flex items-center gap-2"><input type="number" id="livestock" placeholder="Bétail (valeur)" class="asset-input w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" min="0"><div class="tooltip-container"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltip-text">Valeur marchande du bétail destiné au commerce.</span></div></div>
                                <div class="flex items-center gap-2"><input type="number" id="agriculture" placeholder="Produits agricoles (valeur)" class="asset-input w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" min="0"><div class="tooltip-container"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltip-text">Valeur de la récolte après déduction des coûts de production.</span></div></div>
                           </div>
                        </div>

                        <!-- Section 3: Passifs -->
                        <div class="mt-8">
                             <h3 class="text-xl font-bold text-gray-800 border-b border-gray-300 pb-2 mb-4">Passifs Déductibles</h3>
                             <div class="flex items-center gap-2">
                                <input type="number" id="debts" placeholder="Dettes à court terme" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" min="0">
                                <div class="tooltip-container">
                                     <i class="fa-solid fa-circle-info text-gray-400"></i>
                                     <span class="tooltip-text">Uniquement les dettes dues dans les 12 prochains mois (loyer, factures, mensualités de prêt).</span>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons -->
                        <div class="flex flex-col sm:flex-row gap-4 pt-8 no-print">
                            <button id="calculateBtn" class="w-full bg-gradient-to-r from-pink-500 to-orange-400 text-white font-bold py-4 rounded-lg hover:from-pink-600 hover:to-orange-500 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-wait">
                                <span id="calculateBtnText">Calculer ma Zakat</span>
                                <div id="calculateBtnLoader" class="loader mx-auto hidden"></div>
                            </button>
                            <button id="resetBtn" class="w-full sm:w-auto px-6 bg-gray-200 text-gray-700 font-bold py-4 rounded-lg hover:bg-gray-300 transition-all">
                                Réinitialiser
                            </button>
                        </div>
                    </div>
                    <div id="results" class="mt-10 hidden"></div>
                </div>
                <!-- Autres onglets (Historique, Organismes, Paramètres) -->
                <div id="history-tab" class="hidden"><h3 class="text-xl font-bold mb-4">Historique de vos calculs</h3><div id="history-content" class="space-y-4"><p class="text-gray-500">Aucun calcul sauvegardé.</p></div></div>
                <div id="charities-tab" class="hidden"><h3 class="text-xl font-bold mb-4">Organismes de confiance</h3><p class="mb-4 text-gray-600">Trouvez des organisations certifiées pour verser votre Zakat.</p><div id="charities-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
                <div id="settings-tab" class="hidden space-y-6"><h3 class="text-xl font-bold">Paramètres</h3><div><label for="zakat-rate" class="block text-sm font-bold text-gray-700">Taux de Zakat (%)</label><input type="number" id="zakat-rate" value="2.5" class="mt-1 w-full p-2 border rounded-md" min="0"></div><button id="save-settings-btn" class="px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700">Sauvegarder</button></div>
            </div>
        </div>
    </div>

    <div id="modal-container"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let state = {
            currency: 'EUR', nisabType: 'gold', chartInstance: null,
            settings: { zakatRate: 0.025 }, history: []
        };

        const elements = {
            currencySelect: document.getElementById('currency'),
            nisabGoldBtn: document.getElementById('nisab_gold_btn'),
            nisabSilverBtn: document.getElementById('nisab_silver_btn'),
            calculateBtn: document.getElementById('calculateBtn'),
            calculateBtnText: document.getElementById('calculateBtnText'),
            calculateBtnLoader: document.getElementById('calculateBtnLoader'),
            resetBtn: document.getElementById('resetBtn'),
            resultsDiv: document.getElementById('results'),
            form: document.getElementById('calculator-form'),
            modalContainer: document.getElementById('modal-container'),
            tabs: document.querySelectorAll('.tab-button'),
            historyContent: document.getElementById('history-content'),
            charitiesList: document.getElementById('charities-list'),
            guideBtn: document.getElementById('guideBtn'),
            zakatRateInput: document.getElementById('zakat-rate'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            goldPriceInput: document.getElementById('gold_price_gram'),
            silverPriceInput: document.getElementById('silver_price_gram'),
            currencySymbolGold: document.getElementById('currency-symbol-gold'),
            currencySymbolSilver: document.getElementById('currency-symbol-silver')
        };
        
        const NISAB_WEIGHTS = { gold: 85, silver: 595 };
        const SUPPORTED_CURRENCIES = {
            "EUR": { symbol: "€", name: "Euro" }, "USD": { symbol: "$", name: "Dollar Américain" }, 
            "SAR": { symbol: "SAR", name: "Riyal Saoudien" }, "AED": { symbol: "AED", name: "Dirham Émirati" }, 
            "GBP": { symbol: "£", name: "Livre Sterling" }, "CAD": { symbol: "C$", name: "Dollar Canadien" },
            "CHF": { symbol: "CHF", name: "Franc Suisse" }, "DZD": { symbol: "DZD", name: "Dinar Algérien" },
            "MAD": { symbol: "MAD", name: "Dirham Marocain" }, "TND": { symbol: "TND", name: "Dinar Tunisien" },
            "XOF": { symbol: "CFA", name: "Franc CFA" }
        };
        
        function init() {
            loadState();
            populateCurrencies();
            updateCurrencySymbols();
            setNisabType(state.nisabType);
            fetchMetalPrices();
            setupEventListeners();
            navigateToTab('calculator');
            renderCharities();
            updateSettingsUI();
        }

        function loadState() {
            const savedSettings = JSON.parse(localStorage.getItem('zakatAppSettings'));
            if (savedSettings) state.settings = { ...state.settings, ...savedSettings };
            const savedHistory = JSON.parse(localStorage.getItem('zakatAppHistory'));
            if (savedHistory) state.history = savedHistory;
            state.currency = localStorage.getItem('zakatAppCurrency') || 'EUR';
        }

        function saveState() {
            localStorage.setItem('zakatAppSettings', JSON.stringify(state.settings));
            localStorage.setItem('zakatAppHistory', JSON.stringify(state.history));
            localStorage.setItem('zakatAppCurrency', state.currency);
        }

        function setupEventListeners() {
            elements.currencySelect.addEventListener('change', (e) => {
                state.currency = e.target.value;
                localStorage.setItem('zakatAppCurrency', state.currency);
                updateCurrencySymbols();
                fetchMetalPrices();
            });
            elements.nisabGoldBtn.addEventListener('click', () => setNisabType('gold'));
            elements.nisabSilverBtn.addEventListener('click', () => setNisabType('silver'));
            elements.calculateBtn.addEventListener('click', calculateZakat);
            elements.resetBtn.addEventListener('click', resetForm);
            elements.tabs.forEach(tab => tab.addEventListener('click', () => navigateToTab(tab.dataset.tab)));
            elements.guideBtn.addEventListener('click', showGuideModal);
            elements.saveSettingsBtn.addEventListener('click', saveSettings);
            elements.form.querySelectorAll('input[type=number]').forEach(input => {
                input.addEventListener('input', () => { if (parseFloat(input.value) < 0) input.value = '0'; });
            });
        }

        function populateCurrencies() {
            for (const code in SUPPORTED_CURRENCIES) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${SUPPORTED_CURRENCIES[code].name} (${SUPPORTED_CURRENCIES[code].symbol})`;
                elements.currencySelect.appendChild(option);
            }
            elements.currencySelect.value = state.currency;
        }

        function updateCurrencySymbols() {
            const symbol = SUPPORTED_CURRENCIES[state.currency]?.symbol || state.currency;
            elements.currencySymbolGold.textContent = symbol;
            elements.currencySymbolSilver.textContent = symbol;
        }
        
        function setNisabType(type) {
            state.nisabType = type;
            elements.nisabGoldBtn.classList.toggle('bg-teal-500', type === 'gold');
            elements.nisabGoldBtn.classList.toggle('text-white', type === 'gold');
            elements.nisabSilverBtn.classList.toggle('bg-teal-500', type === 'silver');
            elements.nisabSilverBtn.classList.toggle('text-white', type === 'silver');
        }

        function navigateToTab(tabId) {
            document.querySelectorAll('[id$="-tab"]').forEach(tc => tc.classList.add('hidden'));
            document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            elements.tabs.forEach(tb => {
                tb.classList.remove('active', 'text-gray-500', 'hover:text-gray-700', 'border-transparent');
                if (tb.dataset.tab === tabId) {
                    tb.classList.add('active');
                } else {
                    tb.classList.add('text-gray-500', 'hover:text-gray-700', 'border-transparent');
                }
            });
            if (tabId === 'history') renderHistory();
        }
        
        function setCalculationState(isLoading) {
            elements.calculateBtn.disabled = isLoading;
            elements.calculateBtnText.classList.toggle('hidden', isLoading);
            elements.calculateBtnLoader.classList.toggle('hidden', !isLoading);
        }

        function resetForm() {
            elements.form.querySelectorAll('input[type=number]').forEach(input => {
                if (!['gold_price_gram', 'silver_price_gram'].includes(input.id)) {
                    input.value = '';
                }
            });
            elements.resultsDiv.innerHTML = '';
            elements.resultsDiv.classList.add('hidden');
            if (state.chartInstance) { state.chartInstance.destroy(); state.chartInstance = null; }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: state.currency }).format(amount);
        }
        
        function renderHistory() {
             elements.historyContent.innerHTML = state.history.length === 0 ? `<p class="text-gray-500">Aucun calcul sauvegardé.</p>`
                : state.history.map((item, index) => `
                <div class="p-4 rounded-lg bg-gray-50 flex justify-between items-center">
                    <div>
                        <p class="font-bold">${new Date(item.date).toLocaleDateString('fr-FR')}</p>
                        <p class="text-lg font-semibold text-teal-600">${formatCurrency(item.zakatDue)}</p>
                    </div>
                    <button class="text-red-500 hover:text-red-700" onclick="window.deleteHistoryItem(${index})"><i class="fa-solid fa-trash"></i></button>
                </div>`).join('');
        }
        
        window.deleteHistoryItem = (index) => { state.history.splice(index, 1); saveState(); renderHistory(); }
        
        function renderCharities() {
            const charities = [
                { name: 'Secours Islamique France', url: 'https://www.secours-islamique.org/' },
                { name: 'Human Appeal France', url: 'https://humanappeal.fr/' },
                { name: 'Muslim Hands France', url: 'https://muslimhands.fr/' },
                { name: 'LIFE ONG', url: 'https://life-ong.org/' }
            ];
            elements.charitiesList.innerHTML = charities.map(c => `
                <div class="p-4 rounded-lg bg-gray-50">
                    <h4 class="font-bold">${c.name}</h4>
                    <a href="${c.url}" target="_blank" class="text-teal-500 hover:underline text-sm">Visiter le site <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                </div>`).join('');
        }
        
        function updateSettingsUI() { elements.zakatRateInput.value = state.settings.zakatRate * 100; }
        
        function saveSettings() {
            const newRate = parseFloat(elements.zakatRateInput.value);
            if (newRate > 0 && newRate < 100) {
                state.settings.zakatRate = newRate / 100;
                saveState();
                alert('Paramètres sauvegardés !');
            } else { alert('Veuillez entrer un taux de Zakat valide (ex: 2.5).'); }
        }

        function createModal(id, title, content) {
            const modalHTML = `<div id="${id}" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40 opacity-0 pointer-events-none"><div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 transform scale-95"><div class="flex justify-between items-center border-b pb-3 mb-4"><h3 class="text-xl font-bold">${title}</h3><button class="modal-close-btn p-2 rounded-full hover:bg-gray-200"><i class="fa-solid fa-times"></i></button></div><div>${content}</div></div></div>`;
            elements.modalContainer.innerHTML = modalHTML;
            const modal = document.getElementById(id);
            modal.querySelector('.modal-close-btn').addEventListener('click', () => closeModal(id));
            modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(id); });
        }
        function openModal(id) { const modal = document.getElementById(id); if(!modal) return; modal.classList.remove('pointer-events-none', 'opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }
        function closeModal(id) { const modal = document.getElementById(id); if(!modal) return; modal.classList.add('opacity-0'); modal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => modal.classList.add('pointer-events-none'), 300); }
        function showGuideModal() {
            createModal('guide-modal', 'Guide de la Zakat', `<h4 class="font-bold text-lg mb-2">Qu'est-ce que la Zakat ?</h4><p class="mb-4">La Zakat est le troisième pilier de l'Islam. C'est une aumône obligatoire que chaque musulman qui en a les moyens doit verser annuellement sur ses biens.</p><h4 class="font-bold text-lg mb-2">Qu'est-ce que le Nisab ?</h4><p class="mb-4">Le Nisab est le seuil minimum de richesse qu'un musulman doit posséder pendant une année lunaire pour être redevable de la Zakat. Il est basé sur la valeur de 85g d'or ou 595g d'argent.</p><h4 class="font-bold text-lg mb-2">Zakat al-Fitr</h4><p class="mb-4">C'est une aumône distincte due avant la prière de l'Aïd al-Fitr. En France, pour 2024-2025, le montant recommandé est de 9€ par personne dans le foyer.</p>`);
            openModal('guide-modal');
        }

        async function fetchMetalPrices() {
            setCalculationState(true);
            try {
                const response = await fetch(`https://api.gold-api.com/price/${state.currency.toLowerCase()}`);
                if (!response.ok) throw new Error('API a échoué');
                const data = await response.json();
                if (!data.price_gram_24k || !data.price_gram_silver) throw new Error('Données invalides');
                elements.goldPriceInput.value = data.price_gram_24k.toFixed(2);
                elements.silverPriceInput.value = data.price_gram_silver.toFixed(2);
            } catch (error) {
                console.warn("API a échoué, utilisation des valeurs par défaut:", error);
                const defaultPrices = { EUR: {g:68.5, s:0.85}, USD: {g:74.2, s:0.92}, SAR: {g:278, s:3.45} };
                elements.goldPriceInput.value = (defaultPrices[state.currency]?.g || 68.5).toFixed(2);
                elements.silverPriceInput.value = (defaultPrices[state.currency]?.s || 0.85).toFixed(2);
            } finally { setCalculationState(false); }
        }

        // NOUVEAU: Fonction de conversion de nombre en toutes lettres
        function numberToWords_fr(number) {
            const units = ["", "un", "deux", "trois", "quatre", "cinq", "six", "sept", "huit", "neuf"];
            const teens = ["dix", "onze", "douze", "treize", "quatorze", "quinze", "seize", "dix-sept", "dix-huit", "dix-neuf"];
            const tens = ["", "dix", "vingt", "trente", "quarante", "cinquante", "soixante", "soixante-dix", "quatre-vingt", "quatre-vingt-dix"];

            function convertToWords(n) {
                if (n === 0) return "";
                function convertChunk(num) {
                    if (num < 10) return units[num];
                    if (num < 20) return teens[num - 10];
                    const ten = Math.floor(num / 10);
                    const unit = num % 10;
                    if (unit === 0) return tens[ten] + (ten === 8 ? 's' : '');
                    if (ten === 7 || ten === 9) return tens[ten-1] + (unit === 1 ? ' et ' : '-') + teens[unit];
                    if (unit === 1 && ten < 8) return tens[ten] + ' et un';
                    return tens[ten] + '-' + units[unit];
                }
                let words = [];
                const billion = Math.floor(n / 1000000000);
                const million = Math.floor((n % 1000000000) / 1000000);
                const thousand = Math.floor((n % 1000000) / 1000);
                const rest = n % 1000;
                if (billion > 0) words.push(convertToWords(billion) + ' milliard' + (billion > 1 ? 's' : ''));
                if (million > 0) words.push(convertToWords(million) + ' million' + (million > 1 ? 's' : ''));
                if (thousand > 0) {
                    if (thousand === 1) words.push('mille');
                    else words.push(convertToWords(thousand).replace(/s$/, '').replace(/un$/, '') + ' mille');
                }
                if (rest > 0) {
                    const hundreds = Math.floor(rest / 100);
                    const remainder = rest % 100;
                    let restWords = '';
                    if (hundreds > 0) {
                        if (hundreds > 1) restWords += units[hundreds] + ' ';
                        restWords += 'cent';
                        if (hundreds > 1 && remainder === 0) restWords += 's';
                    }
                    if (remainder > 0) restWords += (hundreds > 0 ? ' ' : '') + convertChunk(remainder);
                    words.push(restWords);
                }
                return words.join(' ');
            }

            if (number === 0) return "Zéro";
            const intPart = Math.floor(number);
            const decimalPart = Math.round((number - intPart) * 100);
            const currencyInfo = SUPPORTED_CURRENCIES[state.currency] || { name: state.currency };
            let currencyName = currencyInfo.name.toLowerCase().split('(')[0].trim().replace(/s$/, '');
            let intWords = intPart === 0 ? "zéro" : convertToWords(intPart);
            let result = intWords + ' ' + currencyName + (intPart !== 1 ? 's' : '');
            if (decimalPart > 0) {
                let decimalWords = convertToWords(decimalPart);
                result += ' et ' + decimalWords + ' centime' + (decimalPart > 1 ? 's' : '');
            }
            return result.charAt(0).toUpperCase() + result.slice(1);
        }

        function calculateZakat() {
            const getFloat = (id) => parseFloat(document.getElementById(id).value) || 0;
            const goldPrice = getFloat('gold_price_gram');
            const silverPrice = getFloat('silver_price_gram');
            
            if (goldPrice === 0 || silverPrice === 0) {
                alert("Veuillez entrer un prix valide pour l'or et l'argent.");
                return;
            }

            const assetsValues = {
                'Liquidités': getFloat('cash') + getFloat('other_savings'),
                'Or': getFloat('gold_grams') * goldPrice,
                'Argent': getFloat('silver_grams') * silverPrice,
                'Crypto': getFloat('crypto'),
                'Actifs Pro': getFloat('business_assets') + getFloat('real_estate'),
                'Autres': getFloat('livestock') + getFloat('agriculture'),
            };
            
            const totalAssets = Object.values(assetsValues).reduce((s, v) => s + v, 0);
            const debts = getFloat('debts');
            const totalZakatableWealth = totalAssets - debts;
            const nisabValue = NISAB_WEIGHTS[state.nisabType] * (state.nisabType === 'gold' ? goldPrice : silverPrice);

            displayResults(assetsValues, debts, totalZakatableWealth, nisabValue);
        }

        function displayResults(assets, debts, totalZakatableWealth, nisabValue) {
            const zakatDue = (totalZakatableWealth >= nisabValue) ? totalZakatableWealth * state.settings.zakatRate : 0;
            const zakatDueInWords = numberToWords_fr(zakatDue);
            
            const resultsHTML = `<div class="result-card bg-white border border-gray-200 rounded-2xl p-6"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Résumé de votre Zakat</h2><div class="flex gap-2 no-print"><button id="printBtn" class="flex items-center gap-2 text-sm bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 transition"><i class="fa-solid fa-print"></i> Imprimer</button></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center"><div class="space-y-4">${createResultRow('Total Actifs', Object.values(assets).reduce((s, v) => s + v, 0), '+')}${createResultRow('Total Dettes', debts, '-')}<div class="flex justify-between items-center p-3 bg-gray-800 text-white rounded-lg mt-2"><span class="font-bold text-lg">Patrimoine Zakatabale</span><span class="font-extrabold text-xl">${formatCurrency(totalZakatableWealth)}</span></div><div class="flex justify-between items-center p-3 bg-gray-100 border border-dashed rounded-lg mt-4"><span class="font-semibold">Nisab (${state.nisabType})</span><span class="font-bold text-lg">${formatCurrency(nisabValue)}</span></div></div><div class="w-full max-w-xs mx-auto"><canvas id="zakatChart"></canvas></div></div><div class="text-center font-semibold p-4 rounded-lg mt-8 ${zakatDue > 0 ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'}">${zakatDue > 0 ? "Votre patrimoine dépasse le Nisab. La Zakat est due." : "Votre patrimoine est inférieur au Nisab. La Zakat n'est pas due."}</div><div class="text-center mt-6 ${zakatDue > 0 ? '' : 'hidden'}"><p class="text-gray-600 text-lg">Montant total de la Zakat à payer :</p><p class="text-5xl font-extrabold text-pink-500 tracking-tight">${formatCurrency(zakatDue)}</p><p class="text-gray-600 mt-2 text-sm italic">(${zakatDueInWords})</p></div></div>`;
            
            elements.resultsDiv.innerHTML = resultsHTML;
            elements.resultsDiv.classList.remove('hidden');
            document.getElementById('printBtn').addEventListener('click', () => window.print());
            renderChart(Object.keys(assets), Object.values(assets).map(v => Math.max(0, v)));
            setTimeout(() => elements.resultsDiv.querySelector('.result-card').classList.add('show'), 10);
            
            const historyEntry = { date: new Date().toISOString(), zakatDue, currency: state.currency };
            state.history.unshift(historyEntry);
            if (state.history.length > 10) state.history.pop();
            saveState();
        }

        function createResultRow(label, value, sign) {
            return `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg text-sm"><span class="font-medium">${label}</span><span class="font-bold text-base ${sign === '+' ? 'text-green-600' : 'text-red-600'}">${sign} ${formatCurrency(value)}</span></div>`;
        }

        function renderChart(labels, dataValues) {
            const canvas = document.getElementById('zakatChart');
            if (!canvas) return;
            if (state.chartInstance) state.chartInstance.destroy();
            const filteredLabels = labels.filter((_, i) => dataValues[i] > 0);
            const filteredData = dataValues.filter(v => v > 0);
            state.chartInstance = new Chart(canvas, {
                type: 'pie',
                data: { labels: filteredLabels, datasets: [{ data: filteredData, backgroundColor: ['#ef4444', '#f97316', '#8b5cf6', '#3b82f6', '#14b8a6', '#f59e0b'], borderColor: '#ffffff', borderWidth: 2 }] },
                options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#4b5563' } } } }
            });
        }
        
        init();
    });
    </script>
</body>
</html>

