<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application de Zakat Professionnelle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --teal-500: #14b8a6; --teal-600: #0d9488; }
        html.dark { --teal-500: #2dd4bf; --teal-600: #14b8a6; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #fefcff;
            background-image: linear-gradient(135deg, #fce3ec 0%, #e0f2fe 100%);
            transition: background-image 0.3s ease;
        }
        html.dark body { background-color: #111827; background-image: none; }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        html.dark .glass-card {
            background: rgba(31, 41, 55, 0.75);
            border: 1px solid rgba(75, 85, 99, 0.5);
            box-shadow: none;
        }

        /* Nisab Button Active States */
        #nisab_gold_btn, #nisab_silver_btn { transition: all 0.2s ease-in-out; }
        #nisab_gold_btn.active, #nisab_silver_btn.active { background-color: #3b82f6; color: white; }
        html.dark #nisab_gold_btn.active, html.dark #nisab_silver_btn.active { background-color: #14b8a6; }


        /* Tooltip styles */
        .tooltip-container { position: relative; display: inline-block; cursor: pointer; }
        .tooltip-text {
            visibility: hidden; width: 220px; background-color: #1f2937; color: #fff; text-align: center;
            border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%;
            left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 12px;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        .result-card { transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(20px); opacity: 0; }
        .result-card.show { transform: translateY(0); opacity: 1; }
        
        /* Dark Mode Toggle */
        .toggle-checkbox:checked { right: 0; border-color: var(--teal-500); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--teal-500); }
        
        .loader { border: 2px solid #e5e7eb; border-top: 2px solid #ef4444; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        html.dark .loader { border-top-color: var(--teal-500); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Print styles */
        @media print {
            body * { visibility: hidden; }
            #results, #results * { visibility: visible; }
            #results { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="glass-card shadow-2xl rounded-3xl p-6 md:p-10">
            <!-- En-t√™te -->
            <div class="flex justify-between items-center mb-8">
                <div class="text-left">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-white tracking-tight">Zakat Pro</h1>
                    <p class="text-gray-600 dark:text-gray-400 mt-1 text-lg">Votre solution de calcul de Zakat, modernis√©e.</p>
                </div>
                <!-- Dark Mode Toggle -->
                <div class="flex items-center no-print">
                    <span class="mr-3 text-sm font-medium text-gray-900 dark:text-gray-300">‚òÄÔ∏è</span>
                    <label for="dark-toggle" class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" value="" id="dark-toggle" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:bg-teal-600"></div>
                      <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-full"></span>
                    </label>
                    <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300">üåô</span>
                </div>
            </div>
            
            <!-- Formulaire -->
            <div id="calculator-form" class="space-y-8">
                <!-- Section 1: Param√®tres -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="currency" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Devise</label>
                        <select id="currency" class="w-full p-3 bg-white/80 dark:bg-gray-800/80 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 transition">
                            <option value="EUR" selected>Euro (‚Ç¨)</option>
                            <option value="USD">Dollar Am√©ricain ($)</option>
                            <option value="SAR">Riyal Saoudien (SAR)</option>
                            <option value="AED">Dirham √âmirati (AED)</option>
                            <option value="GBP">Livre Sterling (¬£)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Base du Nisab</label>
                        <div class="flex bg-white/80 dark:bg-gray-800/80 border border-gray-300 dark:border-gray-600 rounded-lg p-1">
                            <button id="nisab_gold_btn" class="w-1/2 p-2 rounded-md text-sm font-semibold active">Or (85g)</button>
                            <button id="nisab_silver_btn" class="w-1/2 p-2 rounded-md text-sm font-semibold text-gray-600 dark:text-gray-300">Argent (595g)</button>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Actifs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <h3 class="md:col-span-2 text-xl font-bold text-gray-800 dark:text-white border-b border-gray-300 dark:border-gray-600 pb-2">Actifs Zakatables</h3>
                    <input type="number" id="cash" placeholder="Liquidit√©s (banque, etc.)" class="w-full p-3 bg-white/80 dark:bg-gray-800/80 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500">
                    <input type="number" id="other_savings" placeholder="Actions, placements" class="w-full p-3 bg-white/80 dark:bg-gray-800/80 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500">
                    <input type="number" id="gold_grams" placeholder="Or (en grammes)" class="w-full p-3 bg-white/80 dark:bg-gray-800/80 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500">
                    <input type="number" id="silver_grams" placeholder="Argent (en grammes)" class="w-full p-3 bg-white/80 dark:bg-gray-800/80 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500">
                    <input type="number" id="crypto" placeholder="Cryptomonnaies" class="w-full p-3 bg-white/80 dark:bg-gray-800/80 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500">
                    <input type="number" id="business_assets" placeholder="Actifs commerciaux" class="w-full p-3 bg-white/80 dark:bg-gray-800/80 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500">
                    <input type="number" id="real_estate" placeholder="Immobilier (revente)" class="w-full p-3 bg-white/80 dark:bg-gray-800/80 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500">
                </div>

                <!-- Section 3: Passifs -->
                <div>
                     <h3 class="text-xl font-bold text-gray-800 dark:text-white border-b border-gray-300 dark:border-gray-600 pb-2 mb-4">Passifs D√©ductibles</h3>
                     <div class="flex items-center gap-4">
                        <input type="number" id="debts" placeholder="Dettes √† court terme" class="flex-grow p-3 bg-white/80 dark:bg-gray-800/80 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500">
                        <div class="tooltip-container">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                             <span class="tooltip-text">Incluez les dettes qui sont dues dans l'ann√©e, comme les factures impay√©es, les pr√™ts personnels √† court terme, etc.</span>
                        </div>
                    </div>
                </div>

                <!-- Boutons -->
                <div class="flex flex-col sm:flex-row gap-4 pt-4 no-print">
                    <button id="calculateBtn" class="w-full bg-gradient-to-r from-pink-500 to-orange-400 text-white font-bold py-4 rounded-lg hover:from-pink-600 hover:to-orange-500 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-wait">
                        <span id="calculateBtnText">Calculer ma Zakat</span>
                        <div id="calculateBtnLoader" class="loader mx-auto hidden"></div>
                    </button>
                    <button id="resetBtn" class="w-full sm:w-auto px-6 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-bold py-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all">
                        R√©initialiser
                    </button>
                </div>
            </div>

            <!-- R√©sultats -->
            <div id="results" class="mt-10 hidden">
                <div class="result-card bg-white/90 dark:bg-gray-800/90 border border-gray-200 dark:border-gray-700 rounded-2xl p-6">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">R√©sum√© de votre Zakat</h2>
                        <button id="printBtn" class="no-print flex items-center gap-2 text-sm bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                            Imprimer
                        </button>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                        <div class="space-y-4" id="result-details"></div>
                        <div class="w-full max-w-xs mx-auto">
                            <canvas id="zakatChart"></canvas>
                        </div>
                     </div>
                     <div id="zakat_status_message" class="text-center font-semibold p-4 rounded-lg mt-8"></div>
                     <div id="zakat_due_container" class="text-center mt-6 hidden">
                         <p class="text-gray-600 dark:text-gray-400 text-lg">Montant total de la Zakat √† payer :</p>
                         <p id="zakat_due" class="text-5xl font-extrabold text-pink-500 tracking-tight"></p>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const elements = {
            html: document.documentElement,
            darkToggle: document.getElementById('dark-toggle'),
            currencySelect: document.getElementById('currency'),
            nisabGoldBtn: document.getElementById('nisab_gold_btn'),
            nisabSilverBtn: document.getElementById('nisab_silver_btn'),
            calculateBtn: document.getElementById('calculateBtn'),
            calculateBtnText: document.getElementById('calculateBtnText'),
            calculateBtnLoader: document.getElementById('calculateBtnLoader'),
            resetBtn: document.getElementById('resetBtn'),
            printBtn: document.getElementById('printBtn'),
            resultsDiv: document.getElementById('results'),
            resultCard: document.querySelector('.result-card'),
            form: document.getElementById('calculator-form'),
            zakatChartCanvas: document.getElementById('zakatChart')
        };

        // --- State ---
        let state = {
            currency: 'EUR',
            nisabType: 'gold',
            metalPrices: { gold: 0, silver: 0 },
            chartInstance: null
        };

        // --- Constants ---
        const ZAKAT_RATE = 0.025;
        const NISAB_WEIGHTS = { gold: 85, silver: 595 };
        const OUNCE_TO_GRAM = 31.1035;

        // --- Dark Mode Logic ---
        const applyTheme = () => {
            const isDarkMode = localStorage.getItem('theme') === 'dark';
            elements.darkToggle.checked = isDarkMode;
            elements.html.classList.toggle('dark', isDarkMode);
            setNisabType(state.nisabType); // Re-apply nisab button style for theme change
            if(state.chartInstance) {
                const data = state.chartInstance.data;
                state.chartInstance.destroy();
                renderChart(data.labels, data.datasets[0].data);
            }
        };
        elements.darkToggle.addEventListener('change', () => {
            localStorage.setItem('theme', elements.darkToggle.checked ? 'dark' : 'light');
            applyTheme();
        });

        // --- API & Data Fetching ---
        const fetchMetalPrices = async () => {
            setCalculationState(true);
            try {
                const response = await fetch(`https://data-asg.goldprice.org/dbXRates/${state.currency}`);
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                state.metalPrices.gold = data.items[0].xauPrice / OUNCE_TO_GRAM;
                state.metalPrices.silver = data.items[0].xagPrice / OUNCE_TO_GRAM;
            } catch (error) {
                console.error("Failed to fetch metal prices:", error);
                state.metalPrices.gold = 68.50; 
                state.metalPrices.silver = 0.85;
            } finally {
                setCalculationState(false);
            }
        };

        // --- UI & Event Handlers ---
        elements.currencySelect.addEventListener('change', (e) => {
            state.currency = e.target.value;
            fetchMetalPrices();
        });

        elements.nisabGoldBtn.addEventListener('click', () => setNisabType('gold'));
        elements.nisabSilverBtn.addEventListener('click', () => setNisabType('silver'));
        
        elements.calculateBtn.addEventListener('click', calculateZakat);
        elements.resetBtn.addEventListener('click', resetForm);
        elements.printBtn.addEventListener('click', () => window.print());

        function setNisabType(type) {
            state.nisabType = type;
            const isGold = type === 'gold';
            elements.nisabGoldBtn.classList.toggle('active', isGold);
            elements.nisabSilverBtn.classList.toggle('active', !isGold);
            elements.nisabGoldBtn.classList.toggle('text-gray-600', !isGold);
            elements.nisabGoldBtn.classList.toggle('dark:text-gray-300', !isGold);
            elements.nisabSilverBtn.classList.toggle('text-gray-600', isGold);
            elements.nisabSilverBtn.classList.toggle('dark:text-gray-300', isGold);
        }
        
        function setCalculationState(isLoading) {
            elements.calculateBtn.disabled = isLoading;
            elements.calculateBtnText.classList.toggle('hidden', isLoading);
            elements.calculateBtnLoader.classList.toggle('hidden', !isLoading);
        }

        function resetForm() {
            elements.form.querySelectorAll('input[type=number]').forEach(input => input.value = '');
            elements.resultsDiv.classList.add('hidden');
            elements.resultCard.classList.remove('show');
            if (state.chartInstance) state.chartInstance.destroy();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: state.currency,
                minimumFractionDigits: 2
            }).format(amount);
        }

        // --- Calculation Logic ---
        function calculateZakat() {
            const getFloatValue = (id) => parseFloat(document.getElementById(id).value) || 0;

            const values = {
                cash: getFloatValue('cash'),
                otherSavings: getFloatValue('other_savings'),
                goldGrams: getFloatValue('gold_grams'),
                silverGrams: getFloatValue('silver_grams'),
                crypto: getFloatValue('crypto'),
                businessAssets: getFloatValue('business_assets'),
                realEstate: getFloatValue('real_estate'),
                debts: getFloatValue('debts'),
            };

            const assets = {
                'Liquidit√©s': values.cash + values.otherSavings,
                'Or': values.goldGrams * state.metalPrices.gold,
                'Argent': values.silverGrams * state.metalPrices.silver,
                'Crypto': values.crypto,
                'Actifs Pro': values.businessAssets + values.realEstate
            };
            
            const totalAssets = Object.values(assets).reduce((sum, val) => sum + val, 0);
            const totalZakatableWealth = totalAssets - values.debts;
            const nisabValue = NISAB_WEIGHTS[state.nisabType] * state.metalPrices[state.nisabType];

            displayResults(assets, values.debts, totalZakatableWealth, nisabValue);
        }

        // --- Display Logic ---
        function displayResults(assets, debts, totalZakatableWealth, nisabValue) {
            const resultDetails = document.getElementById('result-details');
            resultDetails.innerHTML = `
                ${createResultRow('Total Actifs', Object.values(assets).reduce((s, v) => s + v, 0), '+')}
                ${createResultRow('Total Dettes', debts, '-')}
                <div class="flex justify-between items-center p-3 bg-gray-800 dark:bg-gray-900 text-white rounded-lg mt-2">
                    <span class="font-bold text-lg">Patrimoine Zakatabale</span>
                    <span class="font-extrabold text-xl">${formatCurrency(totalZakatableWealth)}</span>
                </div>
                 <div class="flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-700 border border-dashed rounded-lg mt-4">
                    <span class="font-semibold">Nisab (${state.nisabType})</span>
                    <span class="font-bold text-lg">${formatCurrency(nisabValue)}</span>
                </div>
            `;
            
            const zakatStatusMessage = document.getElementById('zakat_status_message');
            const zakatDueContainer = document.getElementById('zakat_due_container');
            const zakatDueEl = document.getElementById('zakat_due');

            if (totalZakatableWealth >= nisabValue) {
                const zakatDue = totalZakatableWealth * ZAKAT_RATE;
                zakatStatusMessage.textContent = "Votre patrimoine d√©passe le Nisab. La Zakat est due.";
                zakatStatusMessage.className = 'text-center font-semibold p-4 rounded-lg mt-8 bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300';
                zakatDueEl.textContent = formatCurrency(zakatDue);
                zakatDueContainer.classList.remove('hidden');
            } else {
                zakatStatusMessage.textContent = "Votre patrimoine est inf√©rieur au Nisab. La Zakat n'est pas due.";
                zakatStatusMessage.className = 'text-center font-semibold p-4 rounded-lg mt-8 bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300';
                zakatDueContainer.classList.add('hidden');
            }

            renderChart(Object.keys(assets), Object.values(assets).map(v => Math.max(0, v)));
            
            elements.resultsDiv.classList.remove('hidden');
            setTimeout(() => elements.resultCard.classList.add('show'), 10);
            elements.resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function createResultRow(label, value, sign) {
            const colorClass = sign === '+' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
            return `
                <div class="flex justify-between items-center p-3 bg-white/60 dark:bg-gray-700/60 rounded-lg text-sm">
                    <span class="font-medium">${label}</span>
                    <span class="font-bold text-base ${colorClass}">${sign} ${formatCurrency(value)}</span>
                </div>
            `;
        }

        function renderChart(chartLabels, chartDataValues) {
            if (state.chartInstance) state.chartInstance.destroy();
            
            const chartData = {
                labels: chartLabels,
                datasets: [{
                    data: chartDataValues,
                    backgroundColor: ['#ef4444', '#f97316', '#8b5cf6', '#3b82f6', '#14b8a6'],
                    borderColor: elements.html.classList.contains('dark') ? '#1f2937' : '#ffffff',
                    borderWidth: 2
                }]
            };

            state.chartInstance = new Chart(elements.zakatChartCanvas, {
                type: 'pie',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: elements.html.classList.contains('dark') ? '#d1d5db' : '#4b5563'
                            }
                        }
                    }
                }
            });
        }
        
        // --- Initialisation ---
        applyTheme();
        fetchMetalPrices();
    });
    </script>
</body>
</html>

