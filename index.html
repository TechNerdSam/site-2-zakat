<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zakat Pro Elite | L'Excellence Financière</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        emerald: { 50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b', 950: '#022c22' },
                        gold: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' },
                        slate: { 950: '#020617' }
                    },
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #020617;
            color: #f8fafc;
            overflow-x: hidden;
        }

        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bento-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .bento-card:hover {
            transform: translateY(-4px);
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 20px 40px -20px rgba(16, 185, 129, 0.2);
        }

        .active-nisab {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
            .glass { background: white; border: 1px solid #ccc; color: black; }
        }
    </style>
</head>
<body class="antialiased custom-scrollbar">

    <!-- Background Decoration -->
    <div class="fixed top-0 left-0 w-full h-full pointer-events-none -z-10">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-emerald-900/20 blur-[120px] rounded-full"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-900/10 blur-[120px] rounded-full"></div>
    </div>

    <nav class="sticky top-0 z-50 px-6 py-4 no-print">
        <div class="max-w-7xl mx-auto flex justify-between items-center glass rounded-2xl px-6 py-3">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/20">
                    <i class="fa-solid fa-leaf text-white text-xl"></i>
                </div>
                <span class="text-xl font-extrabold tracking-tight text-white">Zakat<span class="text-emerald-500">Pro</span></span>
            </div>
            <div class="hidden md:flex items-center gap-8">
                <button onclick="navigateToTab('calculator')" class="nav-link text-sm font-semibold text-emerald-500">Calculateur</button>
                <button onclick="navigateToTab('history')" class="nav-link text-sm font-semibold text-slate-400 hover:text-white transition">Historique</button>
                <button onclick="navigateToTab('charities')" class="nav-link text-sm font-semibold text-slate-400 hover:text-white transition">Organismes</button>
            </div>
            <div class="flex items-center gap-4">
                <select id="currency" class="bg-transparent border-none text-sm font-bold text-white focus:ring-0 cursor-pointer"></select>
                <button id="guideBtn" class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center hover:bg-slate-700 transition">
                    <i class="fa-solid fa-circle-question text-slate-300"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- Tab: Calculator -->
        <div id="calculator-tab" class="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
            
            <header class="text-center max-w-2xl mx-auto mb-12">
                <h1 class="text-4xl md:text-6xl font-black text-white mb-4">Purifiez votre <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-teal-500">Capital.</span></h1>
                <p class="text-slate-400 text-lg">L'outil de précision pour remplir votre obligation avec sérénité et exactitude.</p>
            </header>

            <!-- Top Stats / Prices -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass bento-card p-6 rounded-3xl">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-bold uppercase tracking-widest text-slate-500">Prix de l'Or (24k)</span>
                        <div class="w-8 h-8 bg-gold-500/10 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-coins text-gold-500"></i>
                        </div>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <input type="number" id="gold_price_gram" class="bg-transparent text-3xl font-bold text-white w-full border-none focus:ring-0 p-0">
                        <span class="currency-label text-xl font-bold text-slate-500">€</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Mise à jour via API certifiée</p>
                </div>

                <div class="glass bento-card p-6 rounded-3xl">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-bold uppercase tracking-widest text-slate-500">Prix de l'Argent</span>
                        <div class="w-8 h-8 bg-slate-400/10 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-ring text-slate-400"></i>
                        </div>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <input type="number" id="silver_price_gram" class="bg-transparent text-3xl font-bold text-white w-full border-none focus:ring-0 p-0">
                        <span class="currency-label text-xl font-bold text-slate-500">€</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Basé sur le marché mondial</p>
                </div>

                <div class="glass bento-card p-6 rounded-3xl border-emerald-500/20">
                    <span class="text-xs font-bold uppercase tracking-widest text-slate-500 block mb-4">Seuil du Nisab</span>
                    <div class="flex bg-slate-900 rounded-xl p-1 mb-4">
                        <button id="nisab_gold_btn" onclick="setNisabType('gold')" class="flex-1 py-2 rounded-lg text-sm font-bold transition">Or (85g)</button>
                        <button id="nisab_silver_btn" onclick="setNisabType('silver')" class="flex-1 py-2 rounded-lg text-sm font-bold transition">Argent (595g)</button>
                    </div>
                    <div id="nisab-value-display" class="text-2xl font-black text-emerald-400">0.00 €</div>
                </div>
            </div>

            <!-- Main Form Bento Grid -->
            <div id="calculator-form" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Inputs Section -->
                <div class="lg:col-span-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Cash -->
                    <div class="glass bento-card p-6 rounded-3xl flex flex-col justify-between">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-10 h-10 bg-blue-500/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-money-bill-wave text-blue-500"></i></div>
                            <h3 class="font-bold text-white">Liquidités & Épargne</h3>
                        </div>
                        <div class="relative group">
                            <input type="number" id="cash" placeholder="0.00" class="asset-input w-full bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-xl font-bold text-white focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition">
                            <span class="currency-label absolute right-4 top-1/2 -translate-y-1/2 font-bold text-slate-500 group-focus-within:text-emerald-500">€</span>
                        </div>
                    </div>

                    <!-- Gold/Silver Weight -->
                    <div class="glass bento-card p-6 rounded-3xl">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-10 h-10 bg-gold-500/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-gem text-gold-500"></i></div>
                            <h3 class="font-bold text-white">Métaux Précieux</h3>
                        </div>
                        <div class="space-y-4">
                            <div class="relative">
                                <input type="number" id="gold_grams" placeholder="Grammes d'Or" class="asset-input w-full bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-lg font-bold text-white focus:border-emerald-500 transition">
                                <span class="absolute right-4 top-1/2 -translate-y-1/2 font-bold text-slate-500">g (Or)</span>
                            </div>
                            <div class="relative">
                                <input type="number" id="silver_grams" placeholder="Grammes d'Argent" class="asset-input w-full bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-lg font-bold text-white focus:border-emerald-500 transition">
                                <span class="absolute right-4 top-1/2 -translate-y-1/2 font-bold text-slate-500">g (Ar)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Investments -->
                    <div class="glass bento-card p-6 rounded-3xl">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-10 h-10 bg-purple-500/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-chart-line text-purple-500"></i></div>
                            <h3 class="font-bold text-white">Investissements</h3>
                        </div>
                        <div class="space-y-4">
                            <input type="number" id="crypto" placeholder="Crypto (Valeur)" class="asset-input w-full bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-lg font-bold text-white focus:border-emerald-500 transition">
                            <input type="number" id="other_savings" placeholder="Actions & PEA" class="asset-input w-full bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-lg font-bold text-white focus:border-emerald-500 transition">
                        </div>
                    </div>

                    <!-- Business -->
                    <div class="glass bento-card p-6 rounded-3xl">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-10 h-10 bg-orange-500/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-briefcase text-orange-500"></i></div>
                            <h3 class="font-bold text-white">Actifs Commerciaux</h3>
                        </div>
                        <div class="space-y-4">
                            <input type="number" id="business_assets" placeholder="Stocks / Inventaire" class="asset-input w-full bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-lg font-bold text-white focus:border-emerald-500 transition">
                            <input type="number" id="real_estate" placeholder="Immobilier (Vente)" class="asset-input w-full bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-lg font-bold text-white focus:border-emerald-500 transition">
                        </div>
                    </div>

                    <!-- Debts (The negative one) -->
                    <div class="glass bento-card p-6 rounded-3xl md:col-span-2 border-red-500/20">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-10 h-10 bg-red-500/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-hand-holding-dollar text-red-500"></i></div>
                            <h3 class="font-bold text-white">Dettes déductibles (12 mois)</h3>
                        </div>
                        <input type="number" id="debts" placeholder="Montant des dettes" class="asset-input w-full bg-slate-900/50 border border-red-500/10 rounded-2xl p-4 text-xl font-bold text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 transition">
                    </div>
                </div>

                <!-- Summary Section -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="glass p-8 rounded-[2.5rem] border-emerald-500/30 flex flex-col items-center text-center">
                        <h3 class="text-slate-400 font-bold uppercase tracking-widest text-xs mb-6">Montant estimé de la Zakat</h3>
                        <div id="zakat-display" class="text-6xl font-black text-white mb-2">0.00</div>
                        <div class="currency-label text-2xl font-bold text-emerald-500 mb-8">EURO</div>
                        
                        <div class="w-full space-y-3 no-print">
                            <button id="calculateBtn" onclick="calculateZakat()" class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-black py-5 rounded-2xl transition-all active:scale-95 shadow-xl shadow-emerald-500/20">
                                CALCULER MAINTENANT
                            </button>
                            <button onclick="resetForm()" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-4 rounded-2xl transition">
                                Réinitialiser
                            </button>
                        </div>
                    </div>

                    <div class="glass p-6 rounded-3xl">
                        <canvas id="zakatChart" class="w-full aspect-square"></canvas>
                    </div>
                </div>
            </div>

            <!-- Results Report Section -->
            <div id="results" class="hidden mt-12 glass p-10 rounded-[3rem] animate-in fade-in zoom-in duration-500"></div>
        </div>

        <!-- Tab: History -->
        <div id="history-tab" class="hidden space-y-8">
            <h2 class="text-3xl font-black text-white">Historique des Purifications</h2>
            <div id="history-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- Tab: Charities -->
        <div id="charities-tab" class="hidden space-y-8">
            <h2 class="text-3xl font-black text-white">Où verser votre Zakat ?</h2>
            <div id="charities-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </div>
    </main>

    <!-- Modal System -->
    <div id="modal-container" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-slate-950/80 backdrop-blur-md"></div>

    <script>
        const NISAB_WEIGHTS = { gold: 85, silver: 595 };
        const SUPPORTED_CURRENCIES = {
            "EUR": { symbol: "€", name: "Euro" },
            "USD": { symbol: "$", name: "Dollar" },
            "SAR": { symbol: "SAR", name: "Riyal Saoudien" },
            "AED": { symbol: "AED", name: "Dirham" },
            "GBP": { symbol: "£", name: "Livre Sterling" }
        };

        let state = {
            currency: 'EUR',
            nisabType: 'gold',
            zakatRate: 0.025,
            history: JSON.parse(localStorage.getItem('zakat_pro_history') || '[]'),
            chart: null,
            goldPrice: 82.40, // Valeurs 2026 estimées
            silverPrice: 1.05
        };

        const elements = {
            currency: document.getElementById('currency'),
            goldPrice: document.getElementById('gold_price_gram'),
            silverPrice: document.getElementById('silver_price_gram'),
            nisabDisplay: document.getElementById('nisab-value-display'),
            zakatDisplay: document.getElementById('zakat-display'),
            results: document.getElementById('results'),
            historyContent: document.getElementById('history-content'),
            charitiesList: document.getElementById('charities-list'),
            modal: document.getElementById('modal-container')
        };

        function init() {
            populateCurrencies();
            fetchPrices(); 
            renderCharities();
            setNisabType('gold');
            setupRealTimeListeners();
        }

        function populateCurrencies() {
            Object.entries(SUPPORTED_CURRENCIES).forEach(([code, info]) => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = `${code} (${info.symbol})`;
                elements.currency.appendChild(opt);
            });
            elements.currency.addEventListener('change', (e) => {
                state.currency = e.target.value;
                updateLabels();
                fetchPrices();
            });
        }

        /**
         * fetchPrices avec gestion multi-sources et robuste aux 404
         */
        async function fetchPrices(retries = 3, delay = 1000) {
            const currency = state.currency.toUpperCase();
            // Liste des serveurs API alternatifs pour éviter les 404
            const endpoints = [
                `https://api.gold-api.com/price/${currency}`,
                `https://api.gold-api.com/price/XAU/${currency}`
            ];

            let success = false;
            
            for (const url of endpoints) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) continue; // On essaie le suivant si 404 ou autre
                    
                    const data = await res.json();
                    if (data.price_gram_24k && data.price_gram_silver) {
                        state.goldPrice = data.price_gram_24k;
                        state.silverPrice = data.price_gram_silver;
                        success = true;
                        break;
                    }
                } catch (e) {
                    console.warn(`Échec sur ${url}, tentative suivante...`);
                }
            }

            if (success) {
                elements.goldPrice.value = state.goldPrice.toFixed(2);
                elements.silverPrice.value = state.silverPrice.toFixed(2);
                updateNisabDisplay();
                console.log(`[OK] Prix mis à jour pour ${currency}`);
            } else if (retries > 0) {
                console.warn(`[RETRY] Aucun endpoint n'a répondu. Nouvelle tentative dans ${delay}ms...`);
                await new Promise(r => setTimeout(r, delay));
                return fetchPrices(retries - 1, delay * 1.5);
            } else {
                // Échec total : application des fallbacks silencieusement
                console.log("Utilisation des cours de référence 2026 (Secours)");
                const defaults = { 
                    EUR: {g: 82.50, s: 1.05}, 
                    USD: {g: 89.20, s: 1.15}, 
                    SAR: {g: 335.00, s: 4.30} 
                };
                const currentDefault = defaults[currency] || defaults.EUR;
                state.goldPrice = currentDefault.g;
                state.silverPrice = currentDefault.s;
                elements.goldPrice.value = state.goldPrice.toFixed(2);
                elements.silverPrice.value = state.silverPrice.toFixed(2);
                updateNisabDisplay();
            }
        }

        function setNisabType(type) {
            state.nisabType = type;
            const goldBtn = document.getElementById('nisab_gold_btn');
            const silverBtn = document.getElementById('nisab_silver_btn');
            
            if(type === 'gold') {
                goldBtn.className = "flex-1 py-2 rounded-lg text-sm font-bold active-nisab text-slate-950";
                silverBtn.className = "flex-1 py-2 rounded-lg text-sm font-bold text-slate-400 hover:text-white";
            } else {
                silverBtn.className = "flex-1 py-2 rounded-lg text-sm font-bold active-nisab text-slate-950";
                goldBtn.className = "flex-1 py-2 rounded-lg text-sm font-bold text-slate-400 hover:text-white";
            }
            updateNisabDisplay();
        }

        function updateNisabDisplay() {
            const price = parseFloat(elements.goldPrice.value) || state.goldPrice;
            const silverP = parseFloat(elements.silverPrice.value) || state.silverPrice;
            const currentP = state.nisabType === 'gold' ? price : silverP;
            const val = currentP * NISAB_WEIGHTS[state.nisabType];
            elements.nisabDisplay.textContent = formatCurrency(val);
        }

        function formatCurrency(val) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: state.currency }).format(val);
        }

        function calculateZakat() {
            const getVal = id => parseFloat(document.getElementById(id).value) || 0;
            const goldP = parseFloat(elements.goldPrice.value) || state.goldPrice;
            const silverP = parseFloat(elements.silverPrice.value) || state.silverPrice;

            const data = {
                cash: getVal('cash'),
                metals: (getVal('gold_grams') * goldP) + (getVal('silver_grams') * silverP),
                investments: getVal('crypto') + getVal('other_savings'),
                business: getVal('business_assets') + getVal('real_estate'),
                debts: getVal('debts')
            };

            const totalAssets = data.cash + data.metals + data.investments + data.business;
            const netWealth = totalAssets - data.debts;
            const nisabValue = (state.nisabType === 'gold' ? goldP : silverP) * NISAB_WEIGHTS[state.nisabType];
            const zakatDue = netWealth >= nisabValue ? netWealth * state.zakatRate : 0;

            elements.zakatDisplay.textContent = zakatDue.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            renderDetailedResults(data, netWealth, nisabValue, zakatDue);
            updateChart(data);
            
            if(zakatDue > 0) saveToHistory(zakatDue);
        }

        function renderDetailedResults(data, net, nisab, due) {
            elements.results.classList.remove('hidden');
            const isEligible = due > 0;
            elements.results.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-start gap-8">
                    <div class="flex-1 space-y-6">
                        <div>
                            <h2 class="text-4xl font-black text-white mb-2">Rapport d'Audit</h2>
                            <p class="text-slate-400">Patrimoine évalué le ${new Date().toLocaleDateString('fr-FR')}</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 rounded-2xl bg-slate-900/50 border border-slate-700">
                                <span class="text-xs font-bold text-slate-500 uppercase">Patrimoine Net</span>
                                <div class="text-2xl font-bold text-white">${formatCurrency(net)}</div>
                            </div>
                            <div class="p-4 rounded-2xl bg-slate-900/50 border border-slate-700">
                                <span class="text-xs font-bold text-slate-500 uppercase">Seuil (Nisab)</span>
                                <div class="text-2xl font-bold text-emerald-400">${formatCurrency(nisab)}</div>
                            </div>
                        </div>
                        <div class="p-6 rounded-[2rem] ${isEligible ? 'bg-emerald-500/10 border-emerald-500/30' : 'bg-amber-500/10 border-amber-500/30'} border">
                            <p class="text-lg font-bold ${isEligible ? 'text-emerald-400' : 'text-amber-400'}">
                                ${isEligible ? 'Votre patrimoine est éligible à la Zakat.' : 'Votre patrimoine est inférieur au seuil.'}
                            </p>
                        </div>
                    </div>
                    <div class="w-full md:w-auto no-print">
                        <button onclick="window.print()" class="px-8 py-4 bg-white text-slate-950 font-black rounded-2xl hover:bg-slate-200 transition flex items-center gap-3">
                            <i class="fa-solid fa-print"></i> IMPRIMER LE RELEVÉ
                        </button>
                    </div>
                </div>
            `;
            elements.results.scrollIntoView({ behavior: 'smooth' });
        }

        function updateChart(data) {
            const ctx = document.getElementById('zakatChart').getContext('2d');
            const values = [data.cash, data.metals, data.investments, data.business];
            if(state.chart) state.chart.destroy();
            state.chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Espèces', 'Métaux', 'Invest.', 'Business'],
                    datasets: [{
                        data: values,
                        backgroundColor: ['#3b82f6', '#fbbf24', '#a855f7', '#f97316'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '70%', plugins: { legend: { display: false } } }
            });
        }

        function saveToHistory(amount) {
            const entry = { date: new Date().toISOString(), amount, currency: state.currency };
            state.history.unshift(entry);
            if(state.history.length > 12) state.history.pop();
            localStorage.setItem('zakat_pro_history', JSON.stringify(state.history));
            renderHistory();
        }

        function renderHistory() {
            elements.historyContent.innerHTML = state.history.length ? state.history.map(h => `
                <div class="glass p-6 rounded-3xl border-slate-700/50">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-bold text-slate-500">${new Date(h.date).toLocaleDateString()}</span>
                        <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                    </div>
                    <div class="text-2xl font-black text-white">${h.amount.toLocaleString()} <span class="text-emerald-500 text-sm">${h.currency}</span></div>
                </div>
            `).join('') : '<p class="text-slate-500 col-span-full text-center py-12">Aucun historique.</p>';
        }

        function renderCharities() {
            const orgs = [
                { name: "Secours Islamique", icon: "fa-hand-holding-heart", color: "text-blue-400" },
                { name: "Human Appeal", icon: "fa-globe", color: "text-emerald-400" },
                { name: "Muslim Hands", icon: "fa-child-reaching", color: "text-orange-400" },
                { name: "LIFE ONG", icon: "fa-heart", color: "text-red-400" }
            ];
            elements.charitiesList.innerHTML = orgs.map(o => `
                <div class="glass bento-card p-6 rounded-3xl text-center">
                    <div class="w-16 h-16 mx-auto bg-slate-800 rounded-2xl flex items-center justify-center mb-4">
                        <i class="fa-solid ${o.icon} ${o.color} text-2xl"></i>
                    </div>
                    <h4 class="font-bold text-white mb-4">${o.name}</h4>
                    <button class="w-full py-2 bg-slate-800 hover:bg-emerald-500 hover:text-slate-950 transition rounded-xl text-xs font-bold">FAIRE UN DON</button>
                </div>
            `).join('');
        }

        function navigateToTab(tabId) {
            ['calculator-tab', 'history-tab', 'charities-tab'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            if(tabId === 'history') renderHistory();
        }

        function updateLabels() {
            document.querySelectorAll('.currency-label').forEach(el => el.textContent = state.currency);
        }

        function setupRealTimeListeners() {
            elements.goldPrice.addEventListener('input', updateNisabDisplay);
            elements.silverPrice.addEventListener('input', updateNisabDisplay);
            document.getElementById('guideBtn').onclick = showGuide;
        }

        function showGuide() {
            elements.modal.classList.remove('hidden');
            elements.modal.classList.add('flex');
            elements.modal.innerHTML = `
                <div class="glass max-w-lg w-full p-8 rounded-[2.5rem] relative">
                    <button onclick="closeModal()" class="absolute top-6 right-6 text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
                    <h3 class="text-2xl font-black text-white mb-6">Comprendre la Zakat</h3>
                    <div class="space-y-4 text-slate-300 text-sm leading-relaxed">
                        <p><strong class="text-emerald-400">Nisab :</strong> Seuil de richesse (85g d'or ou 595g d'argent).</p>
                        <p><strong class="text-emerald-400">Hawl :</strong> Possession du Nisab pendant 1 an lunaire.</p>
                        <p><strong class="text-emerald-400">Taux :</strong> 2,5% des avoirs nets.</p>
                    </div>
                    <button onclick="closeModal()" class="w-full mt-8 py-4 bg-emerald-500 text-slate-950 font-bold rounded-2xl">FERMER</button>
                </div>
            `;
        }

        function closeModal() {
            elements.modal.classList.add('hidden');
            elements.modal.classList.remove('flex');
        }

        function resetForm() {
            document.querySelectorAll('input[type="number"]').forEach(i => {
                if(!['gold_price_gram', 'silver_price_gram'].includes(i.id)) i.value = '';
            });
            elements.zakatDisplay.textContent = "0.00";
            elements.results.classList.add('hidden');
            if(state.chart) state.chart.destroy();
        }

        window.onload = init;
    </script>
</body>
</html>
